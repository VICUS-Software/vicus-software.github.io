---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import type { Language } from '../i18n/languages';
import { HUBSPOT_CONFIG } from '../config/hubspot';

interface Props {
  position?: string;
}

const { position } = Astro.props;
const lang = getLangFromUrl(Astro.url) as Language;
const t = useTranslations(lang);
---

<form
  id="application-form"
  class="space-y-6"
  data-hubspot-portal={HUBSPOT_CONFIG.portalId}
  data-hubspot-form={HUBSPOT_CONFIG.formIds.application}
  enctype="multipart/form-data"
>
  <div class="grid md:grid-cols-2 gap-6">
    <div class="form-group">
      <label for="app-name" class="form-label">
        {t('form.name')} <span class="text-primary">*</span>
      </label>
      <input
        type="text"
        id="app-name"
        name="name"
        required
        class="form-input"
      />
    </div>
    <div class="form-group">
      <label for="app-email" class="form-label">
        {t('form.email')} <span class="text-primary">*</span>
      </label>
      <input
        type="email"
        id="app-email"
        name="email"
        required
        class="form-input"
      />
    </div>
  </div>

  <div class="form-group">
    <label for="app-phone" class="form-label">{t('form.phone')}</label>
    <input
      type="tel"
      id="app-phone"
      name="phone"
      class="form-input"
    />
  </div>

  <div class="form-group">
    <label for="app-position" class="form-label">
      {t('form.position')} <span class="text-primary">*</span>
    </label>
    <input
      type="text"
      id="app-position"
      name="position"
      value={position}
      required
      class="form-input"
      placeholder={lang === 'de' ? 'Position, auf die Sie sich bewerben' : 'Position you are applying for'}
    />
  </div>

  <div class="form-group">
    <label for="app-resume" class="form-label">
      {lang === 'de' ? 'Lebenslauf (PDF)' : 'Resume (PDF)'} <span class="text-primary">*</span>
    </label>
    <input
      type="file"
      id="app-resume"
      name="resume"
      accept=".pdf"
      required
      class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary/10 file:text-primary hover:file:bg-primary/20"
    />
  </div>

  <div class="form-group">
    <label for="app-cover" class="form-label">
      {lang === 'de' ? 'Anschreiben (PDF, optional)' : 'Cover Letter (PDF, optional)'}
    </label>
    <input
      type="file"
      id="app-cover"
      name="coverLetter"
      accept=".pdf"
      class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-primary/10 file:text-primary hover:file:bg-primary/20"
    />
  </div>

  <div class="form-group">
    <label for="app-message" class="form-label">
      {lang === 'de' ? 'Warum möchten Sie bei VICUS arbeiten?' : 'Why do you want to work at VICUS?'}
    </label>
    <textarea
      id="app-message"
      name="message"
      rows="5"
      class="form-input resize-none"
      placeholder={lang === 'de' ? 'Erzählen Sie uns von sich...' : 'Tell us about yourself...'}
    ></textarea>
  </div>

  <div class="form-group">
    <label class="flex items-start gap-3 cursor-pointer">
      <input type="checkbox" name="privacy" required class="mt-1 w-4 h-4 rounded border-foreground/30 text-primary focus:ring-primary" />
      <span class="text-sm text-foreground/70">
        {lang === 'de'
          ? 'Ich stimme der Verarbeitung meiner Daten gemäß der Datenschutzerklärung zu.'
          : 'I agree to the processing of my data according to the privacy policy.'} <span class="text-primary">*</span>
      </span>
    </label>
  </div>

  <div id="application-form-status" class="hidden p-4 rounded-lg"></div>

  <button type="submit" class="btn btn-primary w-full md:w-auto">
    {t('btn.apply')}
  </button>
</form>

<script>
  const form = document.getElementById('application-form') as HTMLFormElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const statusEl = document.getElementById('application-form-status');
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

    submitBtn.disabled = true;
    submitBtn.textContent = '...';

    try {
      await new Promise(resolve => setTimeout(resolve, 1000));

      if (statusEl) {
        statusEl.className = 'p-4 rounded-lg bg-primary/20 text-primary';
        statusEl.textContent = document.documentElement.lang === 'de'
          ? 'Vielen Dank für Ihre Bewerbung! Wir werden uns in Kürze bei Ihnen melden.'
          : 'Thank you for your application! We will contact you shortly.';
        statusEl.classList.remove('hidden');
      }

      form.reset();
    } catch (error) {
      if (statusEl) {
        statusEl.className = 'p-4 rounded-lg bg-red-500/20 text-red-400';
        statusEl.textContent = document.documentElement.lang === 'de'
          ? 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.'
          : 'An error occurred. Please try again.';
        statusEl.classList.remove('hidden');
      }
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = document.documentElement.lang === 'de' ? 'Jetzt bewerben' : 'Apply Now';
    }
  });
</script>
